# 猫语模式使用指南

## 快速开始：让系统进入猫语模式

### 步骤1：准备猫叫声文件

在服务器上创建猫叫声文件夹并添加音频文件：

```bash
# 在xiaozhi-server目录下创建文件夹结构
mkdir -p config/cat_sounds/angry
mkdir -p config/cat_sounds/happy
mkdir -p config/cat_sounds/fearful
```

然后将对应的猫叫声文件放入各个文件夹：
- `config/cat_sounds/angry/` - 放入愤怒情绪的猫叫声（.wav, .mp3, .ogg, .m4a格式）
- `config/cat_sounds/happy/` - 放入高兴情绪的猫叫声
- `config/cat_sounds/fearful/` - 放入惊恐情绪的猫叫声

**建议**：每个情绪文件夹至少准备3-5个不同的音频文件，以增加变化性。

### 步骤2：在Web界面创建猫语TTS模型配置

1. **登录Web管理界面**
   - 打开浏览器访问小智服务器Web管理界面

2. **进入模型配置页面**
   - 点击左侧菜单 "模型配置"
   - 选择 "TTS" 标签页

3. **添加猫语TTS模型**
   - 点击页面上的 "新增" 按钮
   - 在弹出的对话框中填写：
     - **模型ID**: `CatLanguage`（或自定义）
     - **模型名称**: `猫语`（或自定义）
     - **模型编码**: `CatLanguage`（或自定义）
     - **供应器**: 在下拉菜单中选择 **"猫语"**
     - **排序号**: 填写数字（如：1）
   
4. **配置猫语参数**
   - 在"调用信息"部分配置：
     - **猫叫声文件夹路径** (`cat_sounds_dir`): `config/cat_sounds`（默认值，可根据实际情况修改）
     - **默认情绪** (`default_emotion`): `happy`（默认值，当无法识别情绪时使用）

5. **保存配置**
   - 点击 "保存" 按钮
   - 确认模型已成功创建并显示在列表中

### 步骤3：在角色配置中选择猫语TTS

1. **进入角色配置页面**
   - 点击左侧菜单 "角色配置"（或"Agent配置"）

2. **选择或创建角色**
   - 选择一个现有角色进行编辑，或创建新角色

3. **选择TTS模型**
   - 在配置表单中找到 "TTS" 选项
   - 在下拉菜单中选择刚才创建的 **"猫语"** TTS模型
   - 注意：猫语模式不需要选择音色（Voice），因为使用的是预录制的猫叫声

4. **保存角色配置**
   - 点击 "保存" 按钮保存配置

### 步骤4：配置大语言模型以输出情绪信息

为了让系统能够正确识别情绪并播放对应的猫叫声，需要配置大语言模型在回复中包含情绪信息。

#### 方法1：在系统提示词中添加情绪要求

在角色配置的"系统提示词"中添加类似以下内容：

```
请在你的回复中包含情绪信息。你可以使用以下格式：
- [emotion:happy] 表示高兴
- [emotion:angry] 表示愤怒  
- [emotion:fearful] 表示惊恐

或者在回复文本中包含情绪关键词，如：高兴、开心、愤怒、生气、惊恐、害怕等。
```

#### 方法2：使用情绪标签格式

要求大语言模型在回复中使用标签格式，例如：

```
[emotion:happy] 今天天气真好，我很开心！
```

或

```
<emotion>angry</emotion> 我生气了，不想理你。
```

#### 方法3：在回复中包含情绪关键词

大语言模型可以在回复中直接包含情绪关键词，例如：

```
我很高兴见到你！
```

系统会自动识别"高兴"关键词，并播放happy文件夹中的猫叫声。

### 步骤5：测试猫语模式

1. **连接小智客户端**
   - 使用小智客户端连接到服务器

2. **开始对话**
   - 向小智发送消息，例如："你好，今天心情怎么样？"

3. **验证猫叫声**
   - 如果大语言模型回复中包含情绪信息（如"我很高兴"），系统应该播放happy文件夹中的猫叫声
   - 如果回复中包含"生气"、"愤怒"等词，系统应该播放angry文件夹中的猫叫声

## 情绪识别规则

系统会按以下优先级识别情绪：

1. **情绪标签格式**（优先级最高）
   - `[emotion:happy]`
   - `<emotion>angry</emotion>`
   - `情绪:happy` 或 `emotion:angry`

2. **中文关键词**
   - 愤怒：愤怒、生气、恼火、发怒等
   - 高兴：高兴、开心、快乐、愉快、兴奋等
   - 惊恐：惊恐、害怕、恐惧、惊慌等

3. **英文关键词**
   - angry, mad, furious, irritated, annoyed
   - happy, joyful, glad, pleased, excited, cheerful
   - fearful, afraid, scared, frightened, terrified, panic

4. **默认情绪**（如果无法识别）
   - 使用配置的默认情绪（默认：happy）

## 常见问题

### Q1: 为什么没有播放猫叫声？

**检查清单**：
- ✅ 确认在角色配置中选择了"猫语"TTS模型
- ✅ 确认猫叫声文件夹路径正确，且文件夹中存在音频文件
- ✅ 确认音频文件格式支持（.wav, .mp3, .ogg, .m4a）
- ✅ 查看服务器日志，检查是否有错误信息

### Q2: 为什么总是播放同一个猫叫声？

**原因**：可能是该情绪文件夹中只有一个音频文件。

**解决方案**：在对应情绪文件夹中添加多个不同的猫叫声文件，系统会随机选择。

### Q3: 情绪识别不准确怎么办？

**解决方案**：
1. 使用明确的情绪标签格式：`[emotion:happy]`
2. 在系统提示词中明确要求大语言模型输出情绪信息
3. 检查大语言模型的回复是否包含情绪关键词

### Q4: 可以添加更多情绪吗？

**当前支持的情绪**：
- angry（愤怒）
- happy（高兴）
- fearful（惊恐）

如需添加更多情绪，需要修改 `cat_language.py` 文件中的情绪关键词映射和文件夹结构。

### Q5: 如何切换回普通TTS？

**方法**：
1. 进入角色配置页面
2. 将TTS模型从"猫语"改为其他TTS模型（如EdgeTTS、讯飞TTS等）
3. 保存配置

## 配置示例

### 完整的角色配置示例（使用猫语）：

```json
{
  "agentCode": "cat_agent",
  "agentName": "小猫助手",
  "ttsModelId": "TTS_CatLanguage",  // 使用猫语TTS
  "llmModelId": "LLM_ChatGLM",
  "systemPrompt": "你是一只可爱的小猫。请在你的回复中包含情绪信息，使用格式：[emotion:happy] 或 [emotion:angry] 或 [emotion:fearful]。"
}
```

## 注意事项

1. **音频文件质量**：建议使用清晰的猫叫声音频，时长在1-5秒之间
2. **文件命名**：音频文件可以任意命名，系统会自动识别支持的格式
3. **文件夹权限**：确保服务器有读取猫叫声文件夹的权限
4. **性能考虑**：如果音频文件很大，可能会影响响应速度，建议使用较小的音频文件

## 下一步

- 查看 [猫语TTS集成说明](./cat-language-integration.md) 了解技术细节
- 根据需要调整情绪识别关键词
- 优化大语言模型的提示词以获得更好的情绪识别效果


